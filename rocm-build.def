Bootstrap: localimage
From: rocm-base.sif

%setup
    mkdir ${APPTAINER_ROOTFS}/opt/rpms
%post
    zypper refresh
    #zypper --non-interactive dup

    # cd /opt/rpms
    # wget https://repo.radeon.com/amdgpu/6.4/sle/15.6/main/x86_64/libva-amdgpu-2.16.0.60400-2147987.x86_64.rpm
    # wget https://repo.radeon.com/amdgpu/6.4/sle/15.6/main/x86_64/libva-amdgpu-devel-2.16.0.60400-2147987.x86_64.rpm
    # zypper --non-interactive install ./libva-amdgpu-2.16.0.60400-2147987.x86_64.rpm ./libva-amdgpu-devel-2.16.0.60400-2147987.x86_64.rpm
    # rm *.rpm
    zypper -n clean


    # Build ccache from the source
    cd /tmp
    git clone https://github.com/ccache/ccache -b v4.7.5
    cd ccache
    mkdir build
    cd build
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make
    make install
    cd /tmp 
    rm -rf ccache

    # symlinks for ccache
    ln -s /usr/local/bin/ccache /usr/local/bin/gcc
    ln -s /usr/local/bin/ccache /usr/local/bin/g++
    ln -s /usr/local/bin/ccache /usr/local/bin/cc
    ln -s /usr/local/bin/ccache /usr/local/bin/c++
    ln -s /usr/local/bin/ccache /usr/local/bin/amdclang
    ln -s /usr/local/bin/ccache /usr/local/bin/amdclang++
    ln -s /usr/local/bin/ccache /usr/local/bin/hipcc

